<!DOCTYPE html>
<html><head><title>Mawrid Reader</title>
<link rel="shortcut icon" href="aa.ico" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style>
body { width: 100%; background-color: #DDD; }
#chapters_index, #chapter_contents, table.navtable { width: 100%; }
#chapter_contents { font-family: Simplified Arabic; }
body, div { margin: 0; padding: 0; }
/*
table.navtable .button { min-width: 30%; padding: 0;}
a { color: black; text-decoration: none; }
*/
.navtable a, #settings_container a { color: black; text-decoration: none; }
.indexbutton { 
	margin: 0; padding: 0;
	padding-right: 15px;
	padding-left: 15px;
	font-size: xx-large;
	width: 100%; background-color: silver;
	}

#settings_table, #settings-table tr {
	table-layout: fixed;
	width: 100%;
}

#settings_table td {
	width: 15%;
	text-align: center;
}
/*

#settings-table td {
	//width: 30%;
}
.settings-row .button {
	min-width: 10%;
}
*/
.settings-row td {
	min-width: 10%;
}

.book_toggle { 
	width: 100%; background-color: silver;
	font-size: x-large; 
	/*
	text-align: right; 
	*/
	padding-top: 1px; padding-bottom: 1px; 
	}
.button, .presetbutton { 
	background-color: silver;
	font-size: large; text-align: center; 
	padding-top: 7px; padding-bottom: 7px; 
	}
	
.button { width: 100%; }
.presetbutton { min-width: 25%; padding: 3px; margin: 5px; }

.small_button { 
	width: 100%; background-color: silver;
	text-align: center; 
	}

hr { margin: 5px; }

.column_indicator { width: 100% }
.column_indicator td { margin: 2; padding: 2; background-color: gray; }

.column {
	width: 98%;
	overflow: hidden;
}

#settings_container { display: none; }
#settings_container { border: solid white 5px; }

/*
*/

.cols_1, .cols_1_1 { max-width: 95%; }

.cols_2, .cols_2_1, .cols_2_2 { position: relative; width: 190%; }
.cols_2_2 { right: 90%; }

.cols_3, .cols_3_1, .cols_3_2, .cols_3_3 { position: relative; width: 285%; }
.cols_3_2 { left: -95%; }
.cols_3_3 { right: 185%; }


</style>

<script id="book-template" type="text/x-jquery-tmpl">

<!-- Start of book {$name} -->
 <div id="${key}" class='book'>
	<div class='book_toggle ${key}_color' id='${key}_toggle' onclick="javascript:hide_book_build('${key}', false);"> Show ${name} [_] </div>
	<div id='${key}_page'>
	<table class='navtable'>
	<tr>
		<td> <a href='javascript:shift_page("${key}", -1)'><div class='button ${key}_color'>&larr;</div></a> </td>
		<td> <div class='button ${key}_color'>${name}</div></td>
		<td> <a href="javascript:hide_book_build( '${key}', true);"><div class='button ${key}_color'>hide</div></a> </td>
		<td> <a href='javascript:shift_page("${key}", 1)'><div class='button ${key}_color'>&rarr;</div></a> </td>
	</tr>
	</table>
<span class='status_line ${key}_color' id='${key}_status_line'>status</span>
<div class='narrowview ${key}_color' id='${key}_narrowview'>
	<div class='column' id='${col1_div_id}'>
		<img class='image_column cols_${columns} cols_${columns}_${col1_id} swipe' id='${key}_col${col1_id}'>
	</div>
	<hr>
	<div class='column' id='${col2_div_id}'>
		<img class='image_column swipe cols_${columns} cols_${columns}_${col2_id}' id='${key}_col${col2_id}'>
	</div>
	<hr>
	<div class='column' id='${col3_div_id}'>
		<img class='image_column swipe cols_${columns} cols_${columns}_${col3_id}' id='${key}_col${col3_id}'>
	</div>
</div>
<div id='${key}_wideview'>
	<img class='wideview swipe' id='${key}_wideviewimg'>
</div>
<table class='navtable'>
<tr>
	<td> <a href='javascript:shift_page("${key}", -1)'><div class='button ${key}_color'>&larr;</div></a> </td>
	<td> <a href='javascript:shift_page("${key}", 1)' ><div class='button ${key}_color'>&rarr;</div></a> </td>
</tr>
</table>
</div>
<hr>
<hr>
<!-- End of book ${name} -->

</script>
<script id="setting-presets" type="text/x-jquery-tmpl">
	<td>
	<a href="javascript:set_order_preset('${key}')"><div class='button'>${name}</div></a>
</script>
<script id="preset-cell" type="text/x-jquery-tmpl">
<a href='javascript:set_order_preset("${key}")' class='presetbutton ${key}_color'>${name}</a>
</script>
<!--
	<img class='wideview' id='${key}_wideviewimg' onClick='javascript:searchandgo()'>

-->
<script id="settings-row" type="text/x-jquery-tmpl">
<tr class="settings-row, ${key}_color" id="${key}_setting">
<td>${name} <small>(${key})</small>
<td><a href='javascript:move_build("${key}","top")'  title='Move this book to the top'><div class='button, ${key}_color'>&uArr;</div></a>
<td><a href='javascript:move_build("${key}","up")'   title='Move this book up one place'><div class='button, ${key}_color'>&uarr;</div></a>
<td><a href='javascript:move_build("${key}","down")'  title='Move this book down one place'><div class='button, ${key}_color'>&darr;</div></a>
<td><a href='javascript:move_build("${key}","bottom")' title='Move this book to the bottom'><div class='button, ${key}_color'>&dArr;</div></a>
<td><a href='javascript:toggle_hide( "${key}")' title='Hide this book'><div class='button, ${key}_color' id='${key}_hidebutton'>H</div></a>
</tr>


</script>
<script id="rtl-2-column-template" type="text/x-jquery-tmpl">
</script>
<script id="rtl-3-column-template" type="text/x-jquery-tmpl">
</script>

<!-- Google Analytics stuff: -->
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-34010688-1']);
_gaq.push(['_setDomainName', 'ejtaal.net']);
_gaq.push(['_trackPageview']);
(function() {
  if ('file:' != document.location.protocol) {
	  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);

	  var aw = document.createElement('script');
	  aw.type = 'text/javascript'; ga.async = true;
	  aw.src = 'jslib/awstats_misc_tracker.js';
	  var s2 = document.getElementsByTagName('script')[0]; 
	  s2.parentNode.insertBefore(aw, s2);
	}
})();
</script>
<meta name='viewport' content='width=device-width'/>  
</head>
<body>

<table class='navtable'>
<tr>
	<td><a href='javascript:toggle_settings()' title='Settings menu'><div class='button' ><span style='border-top: 3px solid black; border-bottom: 3px solid black;'><b>&mdash;&mdash;&mdash;</b></span></div></a></td>
	<td><a href='readme.html' title='More information about this website'><div class='button'>About</div></a></td>
	<td><a href='javascript:toggle_view()' title='Toggle between mobile (column view) and desktop (full page) view'><div class='button'>Mobile</div></a></td>
	<td><a href='javascript:toggle_fitwidth()' title='Toggle to have pages fit to your browser window'><div class='button'>|&larr;&rarr;|</div></a></td>
	<td><a href='javascript:searchandgo()' title='Lookup root letters'><div class='button'>Search</div></a></td>
</tr>
</table>

<!--
-->
<center>
<span id='statusbar'></span>
<span id='searchbar'></span>
<span id='version'></span> | Viewing mode: <em><span id='currentmode'></span></em>.
<br>
<a href="/donate" style="width: 100%; color: steelblue; border: 1px solid navy;">
 ۩۞۩ Please donate ۩۞۩
</a>
<div id=debug>
</div>
</center>

<center>

<div id='settings_container'>
	<b>Settings</b><br>
	
	Choose the order in which you want the available books displayed:<br>
	<div id='settings_presets'>
	</div>
	You can also choose from these presets:<br>
	<span id="preset-cells">
	</span>
<!--
	<table id="presets_table">
	<tr id="preset-cells">
	</tr>
	</table>
-->
	<hr>
	<table id="settings_table">
	<tbody id="settings_rows">
	</tbody>
<!--
	<td class=".dev">
	<a href="javascript:set_order_preset('dev')"><div class='button'>Dev</div></a>
-->
	</table>
	<br>

	<a href='javascript:save_settings()'><div class='button'>Save</div></a>
	<hr>
</div>

<div id='all_books'>
</div>

<hr>
<table class='navtable'>
<tr>
	<td><a href='javascript:toggle_settings()' title='Settings menu'><div class='button' ><span style='border-top: 3px solid black; border-bottom: 3px solid black;'><b>&mdash;</b></span></div></a></td>
	<td><a href='readme.html' title='More information about this website'><div class='button'>About</div></a></td>
	<td><a href='javascript:toggle_view()' title='Toggle between mobile (column view) and desktop (full page) view'><div class='button'>Mobile</div></a></td>
	<td><a href='javascript:toggle_fitwidth()' title='Toggle to have pages fit to your browser window'><div class='button'>|&larr;&rarr;|</div></a></td>
	<td><a href='javascript:searchandgo()' title='Lookup root letters'><div class='button'>Search</div></a></td>
</tr>
</table>

<!--
http://www.openjs.com/scripts/events/keyboard_shortcuts/
<script type="text/javascript" src="jslib/jquery.touchSwipe.min.js"></script>
<script type="text/javascript" src="jslib/jquery.js"></script>
<script type="text/javascript" src="jslib/jquery.ba-hashchange.min.js"></script>
<script type="text/javascript" src="jslib/jquery.mobile.swipeonly.min.js"></script>
<script type="text/javascript" src="jslib/jquery-1.10.2.js"></script>
-->
<script type="text/javascript" src="jslib/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="jslib/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="jslib/shortcut.js"></script>
<script type="text/javascript" src="jslib/jquery.tmpl.js"></script>
<script type="text/javascript" src="jslib/jquery.cookie.js"></script>
<script type="text/javascript" src="jslib/jquery.total-storage.min.js"></script>
<script type="text/javascript" src="jslib/jquery.mobile-1.3.2.min.js"></script>

<script type="text/javascript" src="mawrid-indexes.js"></script>
<script type="text/javascript" src="mawrid-conf.js"></script>
<script>

// Some global vars that we need:
var debugmode = false; 
var version = "1.0";
var title_text = project["title"] + " - powered by Mawrid Reader" + " v" + version;
var toggle = 1;
var starting_hash = "#";

// Initiate books array with extra needed vars:
for (var key in presets)
	$( "#preset-cell" ).tmpl( presets[key]).appendTo( "#preset-cells" );

for (var key in books) {
	//debug(key)
	books[key]["current"] = books[key]["wanted"] = books[key]["offset"];
	// Set up the right column order for viewing on mobiles
	books[key]["col1_id"] = 1
	books[key]["col2_id"] = 2
	books[key]["col3_id"] = 3
	if ( books[key]['columns'] == 1) {
		$( '#' + key+'col_2').hide()
		$( books[key]['columns']+'col_3').hide()
	}
	else if ( books[key]['columns'] == 2) {
		$( books[key]['columns']+'col_3').hide()
		if ( books[key]['direction'] == 'rtl') {
			books[key]["col1_id"] = 2
			books[key]["col2_id"] = 1
		}
	}
	else if ( books[key]['columns'] == 3) {
		if ( books[key]['direction'] == 'rtl') {
			books[key]["col1_id"] = 3
			books[key]["col2_id"] = 2
			books[key]["col3_id"] = 1
		}
	}

	var book = books[key]
//	for (var prop in book)
//		if (book.hasOwnProperty(prop)) debug(key + "." + prop + " = " + book[prop])
	$( "#book-template" ).tmpl( books[key]).appendTo( "#all_books" );
	$("#"+key+"_toggle").hide()
	$( "#settings-row" ).tmpl( books[key]).appendTo( "#settings_rows" );
	starting_hash += key + '=' + books[key]["offset"] + ',';
	$("."+key+"_color").css('background-color', books[key]["color"])
	$("#"+key+"_wideviewimg").css('border', '3px solid ' + books[key]["color"])
}

for (var key in books) {
	if ( books[key]['columns'] < 2) $( '#' + key+'_col2').hide()
	if ( books[key]['columns'] < 3) $( '#' + key+'_col3').hide()
}

$(function(){
  // Bind the swipeHandler callback function to the swipe event on div.box
  $( ".swipe" ).on( "swiperight", swipe_it);
  $( ".swipe" ).on( "swipeleft", swipe_it );
 
  // Callback function references the event target and adds the 'swipe' class to it
  function swipe_it( event ){
		var pid = $(event.target).closest("div.book").attr("id");
		debug("JQM Swipe event for img under "+pid+":");
		console.log(event);
		if ( event.type == 'swiperight') shift_page( pid, -1);
		if ( event.type == 'swipeleft') shift_page( pid, 1);
  }

	parse_hash();
	$( window ).hashchange(function() {
		parse_hash();
	});

	$(".swipe").click(function(){
		searchandgo()
	});
});

/*
$(function() {
	$(".swipe").swipe({
		swipeLeft:  shift_the_page,
		swipeRight: shift_the_page, 
		swipe:      shift_the_page,
	  tap:function(event, target) {
			//var pid = $(this).parent().attr("id");
	    debug("You tapped" );
			searchandgo();
	  },
		allowPageScroll:"vertical" 
	});

	function shift_the_page(event, direction) {
		//var pid = $(this).parent().parent().parent().attr("id");
		var pid = $(this).closest("div.book").attr("id");
	  //$(this).text("You swiped " + direction );
	  debug("You swiped " + direction + ' on ' + pid);
	  //alert("You swiped " + direction + ' on ' + pid);
		if ( direction == 'right') shift_page( pid, -1);
		if ( direction == 'left') shift_page( pid, 1);
	}
});
*/

starting_hash = starting_hash.replace(/,$/,'')
debug("starting_hash = " + starting_hash)
var initial_book_order = presets["default"];
//var aa_book_order = initial_book_order;

var toggle_view_auto = 1;
var toggle_view_mode;
var fitwidth = false;
var last_input = "";
var searched_word = "";
// This is the base directory under which all image directories will be placed:
var img_base_dir = "img/";

// Only allow .dev classes to show up when we're not live:
// Make not allow it in file: either ? TODO
if ( (document.location.hostname == "localhost") || (document.location.hostname == "abd.ejtaal.net") || (window.location.protocol=='file:') ) 
  $(".dev").show();


// Setup shortcuts:
shortcut.add("F",function() { searchandgo(); });
shortcut.add("V",function() { toggle_view(); });

shortcut.add("Z",function() { visible_book_shift( -1); });
shortcut.add("D",function() { visible_book_shift( -1); });
shortcut.add("Left",function() { visible_book_shift( -1); });
shortcut.add("X",function() { visible_book_shift( 1); });
shortcut.add("G",function() { visible_book_shift( 1); });
shortcut.add("Right",function() { visible_book_shift( 1); });
shortcut.add("P",function() { testing123(); });
shortcut.add("W",function() { toggle_fitwidth(); });


function move_build( id, where) {
	move( id, where)
	build_hash()
}

function move( id, where) {

	var objects = [ '#'+id, '#'+id+"_setting"];
	for (i = 0; i < objects.length; i++) {
		obj = objects[i]
		//$(obj).fadeOut({ duration: 100})
		if ( where == "top" ) { 
			// Move to top
			//debug( "moving "+obj+" to top")
			$(obj).parent().prepend($(obj));
		}
		else if (where == "bottom" ) { 
			//debug( "moving "+obj+" to bottom")
			$(obj).parent().append($(obj));
			//$('#all_objs').append($(obj));
			//$(obj).remove().insertAfter($("#all_objs div:last"));
			//$("#all_objs" .row:first").remove().insertAfter($("#container .row:last));
		}
		else if (where == "up" ) {
			// Move one up
			//debug( "moving "+obj+" 1 up")
			$(obj).after( $(obj).prev() );
		}
		else if (where == "down") {
			// Move one down
			//debug( "moving "+obj+" 1 down")
			$(obj).before( $(obj).next() );
		}
		//$(obj).fadeIn({ duration: 100})
	}
}

function toggle_hide( book) {
	if ( books[book]["should_hide"] == 1)
		books[book]["should_hide"] = 0
	else books[book]["should_hide"] = 1
	build_hash()
}

function hide_book_build( target, should_hide) {
	hide_book( target, should_hide)
	build_hash()
}

function hide_book( target, should_hide) {
	//debug( "hide: " + target + "=" + should_hide)
	books[target]["should_hide"] = should_hide;
	if ( should_hide) {
		hide_show( target+'_page', target+'_toggle');
		$("#"+target+"_hidebutton").css('border','3px solid black')
	}
	else {
		hide_show( target+'_toggle', target+'_page');
		$("#"+target+"_hidebutton").css('border','')
	}
}

function hideme_show( hideobj, showobj) {
  hideobj.style.display = "none";
  //document.getElementById(showobj).style.display = "block";
	$("#"+showobj).show('fast');
}

function hide_id( id, scrollto) {
  //document.getElementById( id).style.display = "none";
	//debug( 'hiding ' + id);
	$("#"+id).hide('fast');
	if (scrollto) {
		//debug( 'scrolling to: ' +id);
		$(window).scrollTop( $("#"+id).offset().top);
	}
}

function hide_show( hideid, showid, scrollto) {
	$("#"+hideid).hide('fast');
	$("#"+showid).show('fast');
	if (scrollto) {
		//debug( 'scrolling to: ' +showid);
		$(window).scrollTop( $("#"+showid).offset().top);
	}
}

function set_hash( s) {
	hide_id('about');
	window.location.hash = s;
	setCookie( project["prefix"]+"last_hash", window.location.hash, 365);
}
function build_hash() {
	var new_hash = "#"

	$('#all_books').children().each(function(){
		var book = $(this).attr('id');
 		//debug( id);
			new_hash += book + "="
			if (books[book]["should_hide"] == 1) new_hash += "h"
			new_hash += books[book]["wanted"] + ','
	})
	new_hash = new_hash.replace(/,$/,'')
	debug("new_hash = " + new_hash);

	window.location.hash = new_hash;
	setCookie( project["prefix"]+"last_hash", window.location.hash, 365);
}

function set_title() {
	var title = "";
	var i = 1;
	//TODO: in order of books displayed:
	if ( searched_word == "" ) {
		$('#all_books').children().each(function(){
			var id = $(this).attr('id');
	 		//debug( id);
			var add_text = "";
			if ( ! books[id]["should_hide"]) add_text = id + ": " + books[id]["index"][books[id]["current"]]
			if ( add_text != "") 
				if ( title != "") title += " / " + add_text;
				else title = add_text;
		});
	}
	else title = "Search: " + searched_word;
	if (title != "") title += " - ";
	title += title_text;
  if ('file:' == document.location.protocol) {
		title = "[L] " + title;
	}
	//alert( title);
	document.title = title;
}

function parse_hash() {
	var hashstring = window.location.hash.replace(/^#/,'');
	var i, vars = hashstring.split(','); 
	if (vars.length > 0) { 
	  // Variables present in hash 
		var hide_following = false
	  for (i = vars.length - 1; i >= 0; i--) { 
	    keyValuePair = vars[i].split('='); 
			//alert( "Var found: " + keyValuePair[0] + ' = ' + keyValuePair[1] );
			var key = keyValuePair[0];
			var value = keyValuePair[1];
			//debug( "Var found: " + keyValuePair[0] + ' = ' + keyValuePair[1] );
			if ( key == "Q" || key == "q" ) { do_search(value); }
			else if ( key == "SEARCH" || key == "search" ) { searchandgo(); }
			else {
				if ( books.hasOwnProperty(key)) {
					books[key]["should_hide"] = 0
					if (value.match( /^h/ )) {
						books[key]["should_hide"] = 1
						value = value.replace(/^h/, '')
					}
					hide_book( key, books[key]["should_hide"]);
					
					books[key]["wanted"] = books[key]["current"] = parseInt(value)
					// all this moving, is it necessary?
					book_index = $('#'+key).index()
					//debug("index: " + book_index + ", arrayindex = " + i)
					// Only move books around if order has changed:
					if ( book_index != i) move(key, "top");
					//move_to_top(key+"_setting");
				}
			}
		}
	}
	else { 
		alert ('Nothing found');
	  // No variables in the hash 
	} 
	display_images();
	set_title();
}

function shift_page( book, offset) {
	hide_id('about');
	books[book]["wanted"] = books[book]["current"] + offset;
	$(window).scrollTop( $("#"+book).offset().top);
	searched_word = "";
	build_hash();
}

function percentVisible( elem)
{
	// This returns how many % of the screen contains element 'elem'
	if ( $(elem).css('display') == "none" ) return 0;
  var docViewTop = $(window).scrollTop();
  var docViewBottom = docViewTop + $(window).height();


  var elemTop = $(elem).offset().top;
  var elemBottom = elemTop + $(elem).height();
	//debug( $(elem).height());
	//debug( 'docViewTop = ' + docViewTop + ', docViewBottom = ' + docViewBottom)
	//debug( 'elem id = ' + $(elem).attr('id') + ', elemTop = ' + elemTop + ', elemBottom = ' + elemBottom)
	var perc_vis = 0;

	// The only assumption here is that the element spans more than 1 screen height
	if ( elemTop <= docViewTop && elemBottom >= docViewBottom) perc_vis = 100;
	else if ( elemBottom < docViewTop || elemTop > docViewBottom) perc_vis = 0;
	else if ( elemTop >= docViewTop ) perc_vis = (docViewBottom-elemTop) * 100  / $(window).height();
	else if ( elemBottom <= docViewBottom ) perc_vis = ( elemBottom-docViewTop) * 100 / $(window).height();
	
	//debug( '=> % = ' + perc_vis + '?');
  
	return perc_vis;
}

function visible_book_shift( offset) {
	for (var key in books) 
		if ( percentVisible("#"+key) > 50) { shift_page( key, offset); break }
}

function get_img_url( book) {
	//debug( "get_img_url( " + book +")")
	var page = books[book]["current"]
	if (page < 1) books[book]["current"] = page = 1
	if (page > books[book]["index"].length)
		books[book]["current"] = page = books[book]["index"].length - 1
	var str = "" + page
	var pad = "0000"
	prefixed_page = pad.substring(0, pad.length - str.length) + str
	return img_base_dir + books[book]["image-prefix"] + "/" + Math.floor(page/100) + "/" +
		books[book]["image-prefix"] + "-" + prefixed_page + ".png"
}

function display_images() {
	//ll_display_page( page);
	//debug ( ll_get_img_url( page));
	//document.getElementById("ll-narrow").src = ll_get_img_url( cur_ll_vol, cur_ll_page);
	// TODO: jQuery-fy the stuff below

	for (var key in books) 
		if ( ! books[key]["should_hide"]) {	
			var img_url = get_img_url(key)
		// Clear image if it's being changed so it's clearer to user that a new imagine
		// is being downloaded
			var status_string = 
				" <b>" + books[key]["index"][books[key]["current"]] + "</b> | " +
				books[key]["name"] + ", page " + (books[key]["current"] - books[key]["offset"] + 1) + 
				" <small>(of " + (books[key]["index"].length-1-books[key]["offset"]) + ") " +
				"</small>"
			if ( $("#"+key+"_col1").attr('src') != img_url) {
				/*
				$("#"+key+"_col1").attr('src', '');
				$("#"+key+"_col2").attr('src', '');
				$("#"+key+"_col3").attr('src', '');
				$("#"+key+"_wideviewimg").attr('src', '');
				*/
				$("#"+key+"_col1").attr('src', img_url);
				$("#"+key+"_col2").attr('src', img_url);
				$("#"+key+"_col3").attr('src', img_url);
				$("#"+key+"_wideviewimg").attr('src', img_url);
				$("#"+key+"_status_line").html( status_string);
			}
		}
	}

function debug( text) {
	var time = new Date().getTime();
	var date = new Date(time);
	var msecs = time % 1000;
	var time_info = date.toString().replace(/(..:..) /,"$1"+"."+msecs+" ")
	
	var str = time_info + " - [" + text + "] "

	if (debugmode) { 
	  document.getElementById("debug").innerHTML += "<br>" + str
	} 
	// Thank you IE for not creating the console element until debug tools
	// are opened!
	if (window.console) console.log(str)
}

// http://constc.blogspot.com/2008/07/undeclared-undefined-null-in-javascript.html
function isUndefined(x) { return x == null && x !== null; }

function first_page_load() {

	if ( $(document.body).width() < 750){ toggle = 2; } 
	else { toggle = 1; }
	toggle_view();
	
	// Set default hash value, and show About if this appears to be the first visit
	if ( window.location.hash.replace(/^#/,'') == "") { 
		var mr_last_hash = getCookie( project["prefix"]+"last_hash");
		debug( mr_last_hash);
		if ( isUndefined(mr_last_hash) || mr_last_hash == "" || mr_last_hash == null) {
			debug('hash = empty, first visit?')
			window.location.hash = starting_hash;
			// Then set the books to default order
			set_order_preset("default");
			//toggle_about();
			//parse_hash();
		} else {
			window.location.hash = mr_last_hash;
		}
	} else parse_hash();
		
	var aa_fitwidth = getCookie( project["prefix"]+"fitwidth");
	if ( ! isUndefined(aa_fitwidth)) {
		fitwidth = aa_fitwidth;
	}

	set_fitwidth();
}

function init_settings() {
	var table_html = "<table><tr>\n";
	for (var row = 0; row <= books.length; row++) {
		//var rowpp = row + 1;
		for (var book = 0 ; book < available_books.length; book++) {
			//var bookpp = book + 1;
			if (book == 0) {
				table_html += "<tr>";
				if (row == 0) table_html += "<td>";
				else  table_html += "<td>" + row;
			}

			if (row == 0) {
				table_html += "<th class='" + available_books[book] + "_color'><b>" + available_books[book] + "</b>";
			} else {
				table_html += "<td class='" + available_books[book] + "_color'><input type='radio' name='setbook" + row + "' value='" + available_books[book] + "'>";
			}
		}
	}
	table_html += "</table>";
	//console.debug(table_html);
	$("#settings_2").html(table_html);

	update_settings_order( aa_book_order);

	$("#version").append(title_text);
}

function update_settings_order( order_toset) {
	var book_array = order_toset.split(',');
	for ( i = book_array.length - 1; i >= 0; i--) {
		var j = i + 1;
		$("input[name=setbook"+j+"][value=" + book_array[i] + "]").prop('checked', true);
	}
}

function set_order_preset( preset) {
	var i, order = presets[preset]['order'].split(',')

	for (var key in books) books[key]['should_hide'] = 1

	if (order.length > 0) {
	  for (i = order.length - 1; i >= 0; i--) {
			hide_book( order[i], false)
			move( order[i], "top")
		}
	}
	build_hash()
}

function save_settings() {
	/*
	var new_book_order = "";
	for ( i = 1; i <= 19; i++ ) new_book_order += $('input[name = "setbook' + i + '"]:checked').val() + ',';
	new_book_order += $('input[name = "setbook20"]:checked').val();
	//new_book_order += $("#setbook8").val();
	//debug(new_book_order);
	aa_book_order = new_book_order;
	set_book_order();
	*/
	toggle_settings();
}

function testing123() {
	var i = 1;
	$('#all_books').children().each(function(){
	 var kid = $(this);
	 debug( kid.attr('id'));
	 i++;
	});

	/*
	for (i=0; i< $('#all_books').children().size(); i++) {
		debug( i);
		debug( $('#all_books').children()[i].attr('id'));
	}
	$(e.target).children().each(function(){
	 var kid = $(this);
	  console.log(kid, kid.attr('id'), kid.attr('class'));
		});
		*/
	//debug( $('#all_books').children().attr('id').each() );
	
	//debug( isScrolledIntoView("#hanswehr"));
//scroll_to_id( 'll_status_line');
//parse_hash();
//document.getElementById("renderedsite").innerHTML = "";
// document.getElementById("renderedsite").innerHTML = document.getElementById("testinput").innerHTML;
	
}


function toggle_fitwidth() {

	if ( toggle_view_mode == 1) {
	  if ( fitwidth == false) {
			fitwidth = true;
		} else { 
			fitwidth = false;
		}
	}
	setCookie( project["prefix"]+'fitwidth', fitwidth, 365);
	set_fitwidth();
}

function set_fitwidth() {
	if ( toggle_view_mode == 1) {
		var mw = '';
	  if ( fitwidth == false) {
			$("#currentmode").html('full width');
		} else { 
			mw = '99%';
			$("#currentmode").html('fit width');
		}
 		$('.wideview').each(function(index) {
				$(this).css('max-width', mw);
    });
		$("#br_wideviewimg").css('max-width', mw);
		$("#vi_wideviewimg").css('max-width', mw); // TODO: Need or not?
		$("#mgf_wideviewimg").css('max-width', mw);// TODO: Need or not?
		$("#ulq_wideviewimg").css('max-width', mw);// TODO: Need or not?
		$("#uqa_wideviewimg").css('max-width', mw);// TODO: Need or not?
		//debug("br_wideview: " + $("#br_wideview").css('max-width'));
	}
}

function toggle_view() {
	// TODO: JQuery-fy this silliness:
	toggle_view_auto = 0;
	if (toggle == 1) {
		$(".narrowview").hide();
		$(".wideview").show();
		$("#currentmode").html("Desktop (full page)");
		toggle_view_mode = 1;
		toggle = 2;
	} else {
		$(".narrowview").show();
		$(".wideview").hide();
		$("#currentmode").html("Mobile (column)");
		toggle = 1;
		toggle_view_mode = 2;
	}

	//setCookie( "toggle_view_auto", toggle_view_auto, 365);
	setCookie( project["prefix"]+"last_view_mode", toggle_view_mode, 365);
	set_fitwidth();
}

/*
// Bind the event.
$(window).hashchange( function(){
	// Alerts every time the hash changes!
	//alert( location.hash );
	parse_hash();
})

*/

function toggle_settings() {
		$('#settings_container').toggle('fast');
}


function searchandgo() {
	//var search = document.getElementById('search').value;
	var input = prompt( "Enter root letters in english or arabic to search (see About section)", last_input);
	if ( ! isUndefined( input) && input != "")
		do_search( input);
}

function do_search( input) {
	if ( isUndefined( input) || input === null || input == "") return
	var search = input;
	last_input = input;
	// TODO: converting all forms of alif and hamza                                             
	// (ء, آ, أ, ؤ, إ, ئ, ا) to a single character ء
	// أكل
	// Here's a funny hamza, what is it?
	// ha_p[25]="ءدب";
	// The same should be done for both forms of yaa (ي, ى)
	/*
		Perform search and replace mostly according to the Arabic Chat Alphabet:
		http://en.wikipedia.org/wiki/Arabic_chat_alphabet
	search = search.replace(//gi,"");
	*/
	// Normalize alifs and yas, not sure if this is right yet?
	// The first character (hamza above alif) is different from the second one, different code page?
	// From android: ء ٱ آ إ
	search = search.replace(/[إآٱأءﺀﺀﺁﺃﺅﺇﺉ]/g,"ا");
	search = search.replace(/[ﻯ]/g,"ي");
	// Firstly the letters that take IMHO 2 letters to transliterate
	search = search.replace(/th/g,"ث");
	search = search.replace(/gh/g,"غ");
	search = search.replace(/[gG]/g,"غ");
	search = search.replace(/kh/g,"خ");
	search = search.replace(/sh/g,"ش");
	search = search.replace(/\$/g,"ش");
	search = search.replace(/dh/g,"ذ");
	search = search.replace(/\*/g,"ذ");
	// Hmm, make the following case insensitive and assign different letters to different cases:
	search = search.replace(/d/g,"د");
	search = search.replace(/D/g,"ض");
	search = search.replace(/z/g,"ز");
	search = search.replace(/Z/g,"ظ");
	search = search.replace(/s/g,"س");
	search = search.replace(/S/g,"ص");
	search = search.replace(/t/g,"ت");
	search = search.replace(/T/g,"ط");
	search = search.replace(/h/g,"ه");
	search = search.replace(/H/g,"ح");
	// Not much iktilaaf over these I guess:
	search = search.replace(/[xX]/g,"خ");
	search = search.replace(/[vV]/g,"ث");
	search = search.replace(/[aA]/g,"ا");
	search = search.replace(/[bB]/g,"ب");
	search = search.replace(/[jJ]/g,"ج");
	search = search.replace(/[7]/g,"ح");
	search = search.replace(/[rR]/g,"ر");
	search = search.replace(/[3]/g,"ع");
	search = search.replace(/[eE]/g,"ع");
	search = search.replace(/[fF]/g,"ف");
	search = search.replace(/[qQ]/g,"ق");
	search = search.replace(/[kK]/g,"ك");
	search = search.replace(/[lL]/g,"ل");
	search = search.replace(/[mM]/g,"م");
	search = search.replace(/[nN]/g,"ن");
	search = search.replace(/[wW]/g,"و");
	search = search.replace(/[yY]/g,"ي");
	debug( "Searching for: " + search);
	for (var key in books) { debug("searching: "+key)
		books[key]["wanted"] = binarySearch( books[key]['index'], search, 0)
	}
	// Headers 

	$("#searchbar").html(
		"Searched for: <strong>" + input + "</strong> (" + search + ") |")
	
	// set searched_word first because build_hash() will lead to set_title() where it is used
	searched_word = search;

	build_hash();
	//parse_hash();
	
}

function getCookie(c_name) {
	// Local Storage is the way of the future
	/*
	var i,x,y,ARRcookies=document.cookie.split(";");
	for (i=0;i<ARRcookies.length;i++) {
  	x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));
  	y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);
  	x=x.replace(/^\s+|\s+$/g,"");
  	if (x==c_name) { return unescape(y); }
  }
	*/
	return $.totalStorage( c_name)
}

function setCookie(c_name,value,exdays)
{
	/*
	// Local Storage is the way of the future
	var exdate=new Date();
	exdate.setDate(exdate.getDate() + exdays);
	var c_value=escape(value) + ((exdays==null) ? "" : "; expires="+exdate.toUTCString());
	document.cookie=c_name + "=" + c_value;
	localStorage.setItem(c_name, value);
	*/
	$.totalStorage( c_name, value);
}

//Copyright 2009 Nicholas C. Zakas. All rights reserved.
//MIT-Licensed, see source file
function binarySearch(items, value, exact_match_fudge, new_chapter_for_letter){
		/*
			exact_match_fudge is the offset to return when an exact
			match is found. By default we track back at least 20 places
			to find the first occurance, however do we then return
			the first occurance or the one before?
			exact_match_fudge = 0 means yes (the former)
			exact_match_fudge = -1 means the one before

			TODO: new_chapter_for_letter, if set, will make searches return the
			next page of what it would normally would return, since the
			new letter starts on the page where the first root with that
			letter occurs also.
		*/

    //debug('items: ' + items + 'value: ' + value + 'exact_match_fudge: ' + exact_match_fudge); 
		value = value.replace( /\s*/g, "");

    var startIndex  = 0,
        stopIndex   = items.length - 1,
        middle      = Math.floor((stopIndex + startIndex)/2),
				retval = 0;

    loop_count = 0;
    while(items[middle] != value && startIndex < stopIndex && loop_count < 100){
        debug(middle+'='+items[middle]); 
        loop_count++; // abd shomad: Temporary countermeasure to prevent endless looping (due to index is not defined). 
        //adjust search area
        if (value < items[middle]) stopIndex = middle - 1;
        if (value > items[middle]) startIndex = middle + 1;
				if (middle != 0 && value < items[middle] && value > items[middle-1]) {
					// This is really the page we want
					debug( "wanted page encountered on path traversing binary branches")
					break
				}
				
				if (loop_count > 98) alert("something fishy, loopcount = 99!");

        //recalculate middle
        middle = Math.floor((stopIndex + startIndex)/2);
        debug("Recalculated middle: " +middle+'='+items[middle]); 
    }
		if ( middle == 0) retval = 0;
		if ( middle > items.length-1) middle = items.length-1;
		if ( items[middle] == value) {
			// Trace back to a max of 20 items to get the first occurance of items[middle] == value
			for (i = 1; i < 20; i++) {
				if ( items[middle-i] != value) {
					// Give the first match if searching for the start of a chapter
					if ( value.length == 1 && exact_match_fudge == -1)
						retval = middle-i+2+exact_match_fudge;
					else 
						retval = middle-i+1+exact_match_fudge;
					break;
				}
				
			}
		} else {
    	//return (items[middle] != value) ? -1 : middle;
    	//return (items[middle] > value && middle > 0) ? middle-1 : middle;
    	//retval = (value > items[middle]) ? middle+1+exact_match_fudge : middle+exact_match_fudge;
    	if (value > items[middle] && value.length == 1) retval = middle+1
			else retval = middle
		}
		debug( 'search = ' + value + ' retval = ' + retval + ' which is: ' + items[retval]);
		return retval;
}

// Do page_load once
first_page_load();

//==========================================================
/* The javascript graveyard:
*/

</script>
<!-- awstats statistics collection script 
<script language=javascript src="jslib/awstats_misc_tracker.js"></script>
/awstats statistics collection script -->
<noscript><img src="jslib/awstats_misc_tracker.js?nojs=y" height=0 width=0 border=0 style="display: none"></noscript>

</body>
</html>
